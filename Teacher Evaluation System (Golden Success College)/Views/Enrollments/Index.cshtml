@model IEnumerable<Teacher_Evaluation_System__Golden_Success_College_.Models.Enrollment>

@{
    ViewData["Title"] = "Enrollments";
    Layout = "_Layoutadmin";
}

<h1>Enrollments</h1>

<div class="mb-3">
    <button class="btn btn-primary" id="btnCreateEnrollment">
        <i class="bi bi-plus-circle"></i> Create Enrollment
    </button>
</div>

<!-- Loading overlay -->
<div id="loadingOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.7); z-index:1050; text-align:center;">
    <div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%);">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <div class="mt-2">Loading...</div>
    </div>
</div>

<table class="table table-bordered table-striped table-sm align-middle w-100" id="enrollmentsTable">
    <thead>
        <tr>
            <th>Student Name</th>
            <th>Subject Name</th>
            <th>Teacher Name</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var item in Model)
        {
            <tr data-id="@item.EnrollmentId">
                <td>@item.Student?.FullName</td>
                <td>@item.Subject?.SubjectName</td>
                <td>@item.Teacher?.FullName</td>
                <td>
                    <button class="btn btn-sm btn-warning btn-edit" data-id="@item.EnrollmentId">
                        <i class="bi bi-pencil-square"></i>
                    </button>
                    <button class="btn btn-sm btn-danger btn-delete" data-id="@item.EnrollmentId">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            </tr>
        }
    </tbody>
</table>

<!-- Modal for Create/Edit -->
<div class="modal fade" id="enrollmentModal" tabindex="-1" aria-labelledby="enrollmentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="enrollmentModalLabel">Create/Edit Enrollment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="enrollmentForm">
                    <input type="hidden" id="EnrollmentId" name="EnrollmentId" />
                    <div class="mb-3">
                        <label for="StudentId" class="form-label">Student</label>
                        <select class="form-select" id="StudentId" name="StudentId" required>
                            <option value="">-- Select Student --</option>
                            @foreach (var student in ViewBag.StudentId as SelectList)
                            {
                                <option value="@student.Value">@student.Text</option>
                            }
                        </select>
                    </div>
                    <div class="mb-3" id="subjectSelectContainer">
                        <label for="SubjectId" class="form-label">Subject</label>
                        <select class="form-select" id="SubjectId" name="SubjectId" required>
                            <option value="">-- Select Subject --</option>
                            @foreach (var subject in ViewBag.SubjectId as SelectList)
                            {
                                <option value="@subject.Value">@subject.Text</option>
                            }
                        </select>
                    </div>
                    <div class="mb-3" id="subjectMultiSelectContainer" style="display:none;">
                        <label for="SubjectIds" class="form-label">Subjects</label>
                        <select class="form-select" id="SubjectIds" name="SubjectIds" multiple size="5">
                            @foreach (var subject in ViewBag.SubjectId as SelectList)
                            {
                                <option value="@subject.Value">@subject.Text</option>
                            }
                        </select>
                        <small class="form-text text-muted">Hold Ctrl (Cmd on Mac) to select multiple subjects.</small>
                    </div>
                    @* <div class="mb-3">
                        <label for="TeacherId" class="form-label">Teacher</label>
                        <select class="form-select" id="TeacherId" name="TeacherId" required>
                            <option value="">-- Select Teacher --</option>
                            @foreach (var teacher in ViewBag.TeacherId as SelectList)
                            {
                                <option value="@teacher.Value">@teacher.Text</option>
                            }
                        </select>
                    </div> *@
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveEnrollmentBtn">
                    <i class="bi bi-check-circle"></i> Save
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notification -->
<div class="position-fixed top-0 end-0 p-3" style="z-index: 11">
    <div id="toast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body" id="toastMessage"></div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        $(document).ready(function () {
            var toastEl = $('#toast');
            var toastMessage = $('#toastMessage');
            var loadingOverlay = $('#loadingOverlay');
            var currentStudentLevelId = 0;

            function showToast(message, bgClass = 'bg-success') {
                toastEl.removeClass('bg-success bg-danger bg-warning bg-info').addClass(bgClass);
                toastMessage.text(message);
                var toast = new bootstrap.Toast(toastEl[0]);
                toast.show();
            }

            function showLoading(show = true) {
                show ? loadingOverlay.show() : loadingOverlay.hide();
            }

            var enrollmentModalEl = document.getElementById('enrollmentModal');
            var enrollmentModal = new bootstrap.Modal(enrollmentModalEl);

            var table = $('#enrollmentsTable').DataTable({
                "columnDefs": [{ "orderable": false, "targets": 3 }]
            });

            // Handle student selection change - Load subjects based on student's level
            $(document).on('change', '#StudentId', function () {
                var studentId = $(this).val();

                if (!studentId) {
                    $('#SubjectId').html('<option value="">-- Select Subject --</option>');
                    $('#SubjectIds').html('');
                    $('#TeacherId').html('<option value="">-- Select Teacher --</option>');
                    currentStudentLevelId = 0;
                    return;
                }

                showLoading(true);

                $.get(`/Enrollments/GetSubjectsByStudent?studentId=${studentId}`, function (response) {
                    showLoading(false);

                    if (response.success && response.data) {
                        currentStudentLevelId = response.studentLevelId;
                        var isCreateMode = !$('#EnrollmentId').val();

                        if (isCreateMode) {
                            // Multi-select for create mode
                            var multiSelectHtml = '';
                            response.data.forEach(function(subject) {
                                multiSelectHtml += `<option value="${subject.subjectId}" data-teacher="${subject.teacherName}">
                                    ${subject.subjectName} (Teacher: ${subject.teacherName})
                                </option>`;
                            });
                            $('#SubjectIds').html(multiSelectHtml);
                        } else {
                            // Single select for edit mode
                            var singleSelectHtml = '<option value="">-- Select Subject --</option>';
                            response.data.forEach(function(subject) {
                                singleSelectHtml += `<option value="${subject.subjectId}">
                                    ${subject.subjectName} (Teacher: ${subject.teacherName})
                                </option>`;
                            });
                            $('#SubjectId').html(singleSelectHtml);

                            var selectedSubjectId = $('#SubjectId').data('selected');
                            if (selectedSubjectId) {
                                $('#SubjectId').val(selectedSubjectId);
                            }
                        }

                        // Load teachers for this level using levelId
                        loadTeachersByLevel(currentStudentLevelId);

                        showToast(`Loaded ${response.data.length} ${response.studentLevel} subject(s)`, 'bg-info');
                    } else {
                        showToast('No subjects found for this student level', 'bg-warning');
                        $('#SubjectId').html('<option value="">-- No Subjects Available --</option>');
                        $('#SubjectIds').html('');
                        $('#TeacherId').html('<option value="">-- No Teachers Available --</option>');
                    }
                }).fail(function() {
                    showLoading(false);
                    showToast('Failed to load subjects', 'bg-danger');
                });
            });

            // Function to load teachers by levelId (NOT level name)
            function loadTeachersByLevel(levelId) {
                if (!levelId || levelId <= 0) return;

                $.get(`/Enrollments/GetTeachersByLevel?levelId=${levelId}`, function (response) {
                    if (response.success && response.data) {
                        var teacherHtml = '<option value="">-- Select Teacher --</option>';
                        response.data.forEach(function(teacher) {
                            teacherHtml += `<option value="${teacher.teacherId}">
                                ${teacher.teacherName}
                            </option>`;
                        });
                        $('#TeacherId').html(teacherHtml);

                        var selectedTeacherId = $('#TeacherId').data('selected');
                        if (selectedTeacherId) {
                            $('#TeacherId').val(selectedTeacherId);
                        }
                    } else {
                        $('#TeacherId').html('<option value="">-- No Teachers Available --</option>');
                    }
                }).fail(function() {
                    showToast('Failed to load teachers', 'bg-danger');
                });
            }

            // Open modal for create
            $('#btnCreateEnrollment').click(function () {
                $('#enrollmentModalLabel').text('Create Enrollment');
                $('#EnrollmentId').val('');
                $('#StudentId').val('');
                $('#SubjectId').val('').removeData('selected');
                $('#SubjectIds').html('');
                $('#TeacherId').val('').removeData('selected');
                currentStudentLevelId = 0;

                $('#subjectSelectContainer').hide();
                $('#subjectMultiSelectContainer').show();
                $('#SubjectId').removeAttr('required');
                $('#SubjectIds').attr('required', 'required');

                enrollmentModal.show();
            });

            // Open modal for edit
            $(document).on('click', '.btn-edit', function () {
                var id = $(this).data('id');
                showLoading(true);

                $.get(`/api/EnrollmentsApi/${id}`, function (res) {
                    showLoading(false);
                    if (res.success) {
                        $('#enrollmentModalLabel').text('Edit Enrollment');
                        $('#EnrollmentId').val(res.data.enrollmentId);
                        $('#StudentId').val(res.data.studentId || '');

                        $('#SubjectId').data('selected', res.data.subjectId || '');
                        $('#TeacherId').data('selected', res.data.teacherId || '');

                        $('#subjectSelectContainer').show();
                        $('#subjectMultiSelectContainer').hide();
                        $('#SubjectId').attr('required', 'required');
                        $('#SubjectIds').removeAttr('required');

                        $('#StudentId').trigger('change');

                        enrollmentModal.show();
                    } else {
                        showToast(res.message, 'bg-danger');
                    }
                }).fail(function () {
                    showLoading(false);
                    showToast('Failed to load enrollment', 'bg-danger');
                });
            });

            // Save enrollment (create or edit)
            $('#saveEnrollmentBtn').click(function () {
                var enrollmentId = $('#EnrollmentId').val();
                var isEdit = enrollmentId && enrollmentId != '';
                var studentId = $('#StudentId').val();

                if (!studentId) {
                    showToast('Please select a student', 'bg-warning');
                    return;
                }

                if (isEdit) {
                    var subjectId = $('#SubjectId').val();
                    var teacherId = $('#TeacherId').val();

                    if (!subjectId) {
                        showToast('Please select a subject', 'bg-warning');
                        return;
                    }

                    if (!teacherId) {
                        showToast('Please select a teacher', 'bg-warning');
                        return;
                    }

                    var enrollmentData = {
                        enrollmentId: parseInt(enrollmentId),
                        studentId: parseInt(studentId),
                        subjectId: parseInt(subjectId),
                        teacherId: parseInt(teacherId)
                    };

                    showLoading(true);
                    $.ajax({
                        url: `/api/EnrollmentsApi/${enrollmentId}`,
                        type: 'PUT',
                        contentType: 'application/json',
                        data: JSON.stringify(enrollmentData),
                        success: function (res) {
                            showLoading(false);
                            if (res.success) {
                                var row = table.row($(`tr[data-id="${enrollmentId}"]`));
                                row.data([
                                    res.data.studentName || '',
                                    res.data.subjectName || '',
                                    res.data.teacherName || '',
                                    `<button class="btn btn-sm btn-warning btn-edit" data-id="${res.data.enrollmentId}"><i class="bi bi-pencil-square"></i></button>
                                     <button class="btn btn-sm btn-danger btn-delete" data-id="${res.data.enrollmentId}"><i class="bi bi-trash"></i></button>`
                                ]).draw(false);
                                showToast(res.message);
                                enrollmentModal.hide();
                            } else {
                                showToast(res.message, 'bg-danger');
                            }
                        },
                        error: function (xhr) {
                            showLoading(false);
                            var errorMsg = 'Failed to save enrollment!';
                            if (xhr.responseJSON && xhr.responseJSON.message) {
                                errorMsg = xhr.responseJSON.message;
                            }
                            showToast(errorMsg, 'bg-danger');
                        }
                    });
                } else {
                    var subjectIds = $('#SubjectIds').val();
                    if (!subjectIds || subjectIds.length === 0) {
                        showToast('Please select at least one subject', 'bg-warning');
                        return;
                    }

                    var enrollmentData = {
                        studentId: parseInt(studentId),
                        subjectIds: subjectIds.map(id => parseInt(id))
                    };

                    showLoading(true);
                    $.ajax({
                        url: '/api/EnrollmentsApi',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(enrollmentData),
                        success: function (res) {
                            showLoading(false);
                            if (res.success) {
                                if (res.data && res.data.length > 0) {
                                    res.data.forEach(function(enrollment) {
                                        var newRow = table.row.add([
                                            enrollment.studentName || '',
                                            enrollment.subjectName || '',
                                            enrollment.teacherName || '',
                                            `<button class="btn btn-sm btn-warning btn-edit" data-id="${enrollment.enrollmentId}"><i class="bi bi-pencil-square"></i></button>
                                             <button class="btn btn-sm btn-danger btn-delete" data-id="${enrollment.enrollmentId}"><i class="bi bi-trash"></i></button>`
                                        ]).draw(false).node();
                                        $(newRow).attr('data-id', enrollment.enrollmentId);
                                    });
                                }
                                showToast(res.message);
                                enrollmentModal.hide();
                            } else {
                                showToast(res.message, 'bg-danger');
                            }
                        },
                        error: function (xhr) {
                            showLoading(false);
                            var errorMsg = 'Failed to save enrollment!';
                            if (xhr.responseJSON && xhr.responseJSON.message) {
                                errorMsg = xhr.responseJSON.message;
                            }
                            showToast(errorMsg, 'bg-danger');
                        }
                    });
                }
            });

            // Delete enrollment
            $(document).on('click', '.btn-delete', function () {
                if (!confirm('Are you sure you want to delete this enrollment?')) return;
                var id = $(this).data('id');

                showLoading(true);
                $.ajax({
                    url: `/api/EnrollmentsApi/${id}`,
                    type: 'DELETE',
                    success: function (res) {
                        showLoading(false);
                        if (res.success) {
                            table.row($(`tr[data-id="${id}"]`)).remove().draw();
                            showToast(res.message);
                        } else {
                            showToast(res.message, 'bg-danger');
                        }
                    },
                    error: function () {
                        showLoading(false);
                        showToast('Failed to delete!', 'bg-danger');
                    }
                });
            });
        });
    </script>
}