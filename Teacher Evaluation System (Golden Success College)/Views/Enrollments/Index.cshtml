@model IEnumerable<Teacher_Evaluation_System__Golden_Success_College_.Models.Enrollment>

@{
    ViewData["Title"] = "Enrollments";
    Layout = "_Layoutadmin";
    var userRole = ViewBag.UserRole as string;
    var isStudentUser = ViewBag.IsStudentUser as bool? ?? false;
    var currentStudentId = ViewBag.CurrentStudentId;
}

<h1>Enrollments</h1>

@if (TempData["Success"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["Success"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @TempData["Error"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@if (TempData["Warning"] != null)
{
    <div class="alert alert-warning alert-dismissible fade show" role="alert">
        @TempData["Warning"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@if (TempData["Info"] != null)
{
    <div class="alert alert-info alert-dismissible fade show" role="alert">
        @TempData["Info"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<div class="mb-3">
    <button class="btn btn-primary" id="btnCreateEnrollment">
        <i class="bi bi-plus-circle"></i> Create Enrollment
    </button>
</div>

<!-- Loading overlay -->
<div id="loadingOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:1050; text-align:center;">
    <div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%);">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
        <div class="mt-3 fw-bold">Processing...</div>
    </div>
</div>

<!-- Enrollment Cards Grid -->
<div class="row g-4">
    @if (!Model.Any())
    {
        <div class="col-12">
            <div class="alert alert-info text-center">
                <i class="bi bi-info-circle fs-4"></i>
                <p class="mb-0 mt-2">No enrollments found. Click "Create Enrollment" to get started.</p>
            </div>
        </div>
    }
    else
    {
        @foreach (var item in Model)
        {
            <div class="col-lg-4 col-md-6 col-sm-12">
                <div class="card text-center shadow-sm h-100" style="border-radius:1.25rem;">
                    <div class="card-body d-flex flex-column">
                        <img src="@(string.IsNullOrWhiteSpace(item.Teacher?.PicturePath) ? "/images/default-profile.png" : item.Teacher.PicturePath)"
                             alt="Teacher Picture" class="mb-3 mx-auto"
                             style="width:80px;height:80px;border-radius:50%;border:3px solid #43a047;object-fit:cover;" />

                        <h5 class="card-title mb-1">@item.Student?.FullName</h5>
                        <div class="text-muted small mb-2">
                            <i class="bi bi-mortarboard"></i> @item.Student?.Level?.LevelName
                        </div>
                        <hr />
                        <div class="mb-2">
                            <strong><i class="bi bi-book"></i> Subject:</strong><br />
                            <span class="text-primary">@item.Subject?.SubjectName</span>
                        </div>
                        <div class="mb-3">
                            <strong><i class="bi bi-person"></i> Teacher:</strong><br />
                            <span class="text-success">@item.Teacher?.FullName</span>
                        </div>

                        @if (userRole == "Admin" || userRole == "Super Admin")
                        {
                            <div class="mt-auto d-grid gap-2">
                                <button class="btn btn-warning btn-edit" data-id="@item.EnrollmentId">
                                    <i class="bi bi-pencil-square"></i> Edit
                                </button>
                                <button class="btn btn-danger btn-delete" data-id="@item.EnrollmentId">
                                    <i class="bi bi-trash"></i> Delete
                                </button>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
    }
</div>

<!-- Modal: Create/Edit Enrollment -->
<div class="modal fade" id="enrollmentModal" tabindex="-1" aria-labelledby="enrollmentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="enrollmentModalLabel">Create Enrollment</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="enrollmentForm">
                    @Html.AntiForgeryToken()
                    <input type="hidden" id="EnrollmentId" name="EnrollmentId" />

                    <div class="mb-3">
                        <label for="StudentId" class="form-label">
                            <i class="bi bi-person-fill"></i> Student <span class="text-danger">*</span>
                        </label>
                        @{
                            var students = ViewBag.StudentId as SelectList;
                            var optionsHtml = "";
                            foreach (var student in students)
                            {
                                var selected = (currentStudentId != null && currentStudentId.ToString() == student.Value) ? "selected=\"selected\"" : "";
                                optionsHtml += $"<option value=\"{student.Value}\" {selected}>{student.Text}</option>";
                            }
                        }
                        <select class="form-select" id="StudentId" name="StudentId" required @(isStudentUser ? "disabled" : "")>
                            <option value="">-- Select Student --</option>
                            @Html.Raw(optionsHtml)
                        </select>
                        <div class="invalid-feedback">Please select a student.</div>
                    </div>

                    <div class="mb-3" id="subjectSelectContainer">
                        <label for="SubjectId" class="form-label">
                            <i class="bi bi-book-fill"></i> Subject <span class="text-danger">*</span>
                        </label>
                        <select class="form-select" id="SubjectId" name="SubjectId" required>
                            <option value="">-- Select Subject --</option>
                        </select>
                        <div class="invalid-feedback">Please select a subject.</div>
                    </div>

                    <div class="mb-3" id="subjectMultiSelectContainer" style="display:none;">
                        <label for="SubjectIds" class="form-label">
                            <i class="bi bi-book-fill"></i> Subjects <span class="text-danger">*</span>
                        </label>
                        <select class="form-select" id="SubjectIds" name="SubjectIds" multiple size="6">
                            <option disabled>-- Loading subjects... --</option>
                        </select>
                        <small class="form-text text-muted">
                            <i class="bi bi-info-circle"></i> Hold Ctrl (Cmd on Mac) to select multiple subjects.
                        </small>
                        <div class="invalid-feedback">Please select at least one subject.</div>
                    </div>

                    <div id="levelInfo" class="alert alert-info small" style="display:none;">
                        <i class="bi bi-info-circle"></i>
                        <span id="levelInfoText"></span>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Close
                </button>
                <button type="button" class="btn btn-primary" id="saveEnrollmentBtn">
                    <i class="bi bi-check-circle"></i> Save Enrollment
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notifications -->
<div class="position-fixed top-0 end-0 p-3" style="z-index: 11">
    <div id="toast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="true" data-bs-delay="4000">
        <div class="d-flex">
            <div class="toast-body" id="toastMessage"></div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <script>
        $(document).ready(function () {
            var toastEl = $('#toast');
            var toastMessage = $('#toastMessage');
            var loadingOverlay = $('#loadingOverlay');
            var enrollmentModal = new bootstrap.Modal('#enrollmentModal');
            var isStudentUser = @Html.Raw(Json.Serialize(isStudentUser));
            var currentStudentId = @(currentStudentId ?? 0);

            // Setup CSRF token for AJAX requests
            var token = $('input[name="__RequestVerificationToken"]').val();
            $.ajaxSetup({
                headers: {
                    'RequestVerificationToken': token
                }
            });

            // Show toast notification
            function showToast(message, bgClass = 'bg-success') {
                toastEl.removeClass('bg-success bg-danger bg-warning bg-info').addClass(bgClass);
                toastMessage.html(message);
                new bootstrap.Toast(toastEl[0]).show();
            }

            // Reset form
            function resetForm() {
                $('#enrollmentForm')[0].reset();
                $('#EnrollmentId').val('');
                $('#SubjectId').html('<option value="">-- Select Subject --</option>');
                $('#SubjectIds').html('<option disabled>-- Select a student first --</option>');
                $('#levelInfo').hide();
                $('.is-invalid').removeClass('is-invalid');
            }

            // Create Enrollment Button
            $('#btnCreateEnrollment').click(function () {
                $('#enrollmentModalLabel').text('Create Enrollment');
                resetForm();

                if (isStudentUser) {
                    $('#StudentId').val(currentStudentId).prop('disabled', true);
                    $('#subjectSelectContainer').show();
                    $('#subjectMultiSelectContainer').hide();
                    $('#SubjectId').prop('required', true);
                    $('#SubjectIds').prop('required', false);
                    // Auto-load subjects for student
                    loadSubjectsForStudent(currentStudentId);
                } else {
                    $('#StudentId').prop('disabled', false);
                    $('#subjectSelectContainer').hide();
                    $('#subjectMultiSelectContainer').show();
                    $('#SubjectId').prop('required', false);
                    $('#SubjectIds').prop('required', true);
                }

                enrollmentModal.show();
            });

            // Load subjects dynamically when student changes
            $('#StudentId').change(function () {
                var studentId = $(this).val();
                if (!studentId) {
                    $('#SubjectId').html('<option value="">-- Select Subject --</option>');
                    $('#SubjectIds').html('<option disabled>-- Select a student first --</option>');
                    $('#levelInfo').hide();
                    return;
                }
                loadSubjectsForStudent(studentId);
            });

            // Function to load subjects for a student
            function loadSubjectsForStudent(studentId, excludeEnrollmentId = null) {
                var url = `/Enrollments/GetSubjectsByStudent?studentId=${studentId}`;
                if (excludeEnrollmentId) {
                    url += `&excludeEnrollmentId=${excludeEnrollmentId}`;
                }

                $.ajax({
                    url: url,
                    method: 'GET',
                    beforeSend: function() {
                        if (isStudentUser || excludeEnrollmentId) {
                            $('#SubjectId').html('<option value="">-- Loading... --</option>');
                        } else {
                            $('#SubjectIds').html('<option disabled>-- Loading... --</option>');
                        }
                    },
                    success: function (res) {
                        if (res.success) {
                            // Filter only available (non-enrolled) subjects
                            var availableSubjects = res.data.filter(s => !s.isEnrolled);

                            if (availableSubjects.length === 0) {
                                var message = 'No available subjects';
                                if (res.enrolledCount > 0) {
                                    message += ` (already enrolled in ${res.enrolledCount} subject${res.enrolledCount > 1 ? 's' : ''})`;
                                }
                                showToast(message, 'bg-info');
                                $('#SubjectId').html('<option value="">-- All subjects enrolled --</option>');
                                $('#SubjectIds').html('<option disabled>-- All subjects enrolled --</option>');

                                if (res.studentLevel) {
                                    $('#levelInfoText').text(`${res.studentLevel} - Already enrolled in all available subjects`);
                                    $('#levelInfo').removeClass('alert-info').addClass('alert-warning').fadeIn();
                                }
                                return;
                            }

                            // Show level info with available count
                            if (res.studentLevel) {
                                var infoText = `${res.studentLevel} - ${availableSubjects.length} available subject${availableSubjects.length > 1 ? 's' : ''}`;
                                if (res.enrolledCount > 0) {
                                    infoText += ` (${res.enrolledCount} already enrolled)`;
                                }
                                $('#levelInfoText').text(infoText);
                                $('#levelInfo').removeClass('alert-warning').addClass('alert-info').fadeIn();
                            }

                            if (isStudentUser || excludeEnrollmentId) {
                                var html = '<option value="">-- Select Subject --</option>';
                                availableSubjects.forEach(s => {
                                    html += `<option value="${s.subjectId}">${s.subjectName} (${s.teacherName})</option>`;
                                });
                                $('#SubjectId').html(html);
                            } else {
                                var html = '';
                                availableSubjects.forEach(s => {
                                    html += `<option value="${s.subjectId}">${s.subjectName} (${s.teacherName})</option>`;
                                });
                                $('#SubjectIds').html(html);
                            }
                        } else {
                            showToast(res.message || 'Failed to load subjects', 'bg-danger');
                            $('#SubjectId').html('<option value="">-- Error loading subjects --</option>');
                            $('#SubjectIds').html('<option disabled>-- Error loading subjects --</option>');
                        }
                    },
                    error: function (xhr) {
                        var errorMsg = xhr.responseJSON?.message || 'Failed to load subjects';
                        showToast(errorMsg, 'bg-danger');
                        $('#SubjectId').html('<option value="">-- Error loading subjects --</option>');
                        $('#SubjectIds').html('<option disabled>-- Error loading subjects --</option>');
                    }
                });
            }

            // Edit Enrollment - THIS IS WHERE THE CODE GOES!
            $(document).on('click', '.btn-edit', function () {
                var id = $(this).data('id');
                loadingOverlay.show();

                $.ajax({
                    url: `/api/EnrollmentsApi/${id}`,
                    method: 'GET',
                    success: function (res) {
                        loadingOverlay.hide();
                        if (res.success) {
                            $('#enrollmentModalLabel').text('Edit Enrollment');
                            $('#EnrollmentId').val(res.data.enrollmentId);
                            $('#StudentId').val(res.data.studentId).prop('disabled', true);

                            // Load ALL subjects for the student (including enrolled) for edit mode
                            $.ajax({
                                url: `/Enrollments/GetSubjectsByStudent?studentId=${res.data.studentId}&excludeEnrollmentId=${res.data.enrollmentId}&showEnrolled=true`,
                                method: 'GET',
                                success: function (subjects) {
                                    if (subjects.success) {
                                        var html = '';
                                        var currentSubjectFound = false;

                                        // THIS IS WHERE YOUR CODE GOES - Loop through subjects and add labels
                                        subjects.data.forEach(s => {
                                            var selected = s.subjectId == res.data.subjectId ? 'selected' : '';
                                            var enrolledTag = '';

                                            // ⭐ YOUR CODE IS HERE ⭐
                                            // Mark as current or already enrolled
                                            if (s.subjectId == res.data.subjectId) {
                                                enrolledTag = ' (Current)';  // The subject being edited
                                                currentSubjectFound = true;
                                            } else if (s.isEnrolled) {
                                                enrolledTag = ' (Already Enrolled)';  // Other enrolled subjects
                                            }
                                            // No tag = Available subject

                                            html += `<option value="${s.subjectId}" ${selected}>${s.subjectName} (${s.teacherName})${enrolledTag}</option>`;
                                        });

                                        if (subjects.data.length === 0) {
                                            html = '<option value="">No subjects available</option>';
                                        }

                                        $('#SubjectId').html(html);

                                        if (subjects.studentLevel) {
                                            var availableCount = subjects.data.filter(s => !s.isEnrolled).length;
                                            var infoText = `${subjects.studentLevel} - ${availableCount} available`;
                                            if (subjects.enrolledCount > 0) {
                                                infoText += `, ${subjects.enrolledCount} enrolled`;
                                            }
                                            $('#levelInfoText').text(infoText);
                                            $('#levelInfo').removeClass('alert-warning').addClass('alert-info').fadeIn();
                                        }
                                    }

                                    $('#subjectSelectContainer').show();
                                    $('#subjectMultiSelectContainer').hide();
                                    $('#SubjectId').prop('required', true);
                                    $('#SubjectIds').prop('required', false);

                                    enrollmentModal.show();
                                },
                                error: function() {
                                    loadingOverlay.hide();
                                    showToast('Failed to load subjects for editing', 'bg-danger');
                                }
                            });
                        } else {
                            showToast(res.message || 'Failed to load enrollment', 'bg-danger');
                        }
                    },
                    error: function (xhr) {
                        loadingOverlay.hide();
                        var errorMsg = xhr.responseJSON?.message || 'Failed to load enrollment';
                        showToast(errorMsg, 'bg-danger');
                    }
                });
            });

            // Save Enrollment
            $('#saveEnrollmentBtn').click(function () {
                // Clear previous validation
                $('.is-invalid').removeClass('is-invalid');

                var enrollmentId = $('#EnrollmentId').val();
                var studentId = $('#StudentId').val();

                // Validation
                if (!studentId) {
                    $('#StudentId').addClass('is-invalid');
                    showToast('Please select a student', 'bg-warning');
                    return;
                }

                var subjects = isStudentUser || enrollmentId
                    ? [$('#SubjectId').val()].filter(Boolean)
                    : $('#SubjectIds').val() || [];

                if (subjects.length === 0) {
                    if (isStudentUser || enrollmentId) {
                        $('#SubjectId').addClass('is-invalid');
                    } else {
                        $('#SubjectIds').addClass('is-invalid');
                    }
                    showToast('Please select at least one subject', 'bg-warning');
                    return;
                }

                // Prepare payload
                var payload = enrollmentId
                    ? {
                        enrollmentId: parseInt(enrollmentId),
                        studentId: parseInt(studentId),
                        subjectId: parseInt(subjects[0]),
                        teacherId: 0  // Backend will determine this
                      }
                    : {
                        studentId: parseInt(studentId),
                        subjectIds: subjects.map(x => parseInt(x))
                      };

                // Send request
                $.ajax({
                    url: enrollmentId ? `/api/EnrollmentsApi/${enrollmentId}` : '/api/EnrollmentsApi',
                    method: enrollmentId ? 'PUT' : 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(payload),
                    beforeSend: function() {
                        loadingOverlay.show();
                        $('#saveEnrollmentBtn').prop('disabled', true);
                    },
                    success: function (res) {
                        loadingOverlay.hide();
                        $('#saveEnrollmentBtn').prop('disabled', false);

                        if (res.success) {
                            var message = res.message;
                            if (res.errors && res.errors.length > 0) {
                                message += '<br><small>' + res.errors.join('<br>') + '</small>';
                            }
                            showToast(message, res.errors && res.errors.length > 0 ? 'bg-warning' : 'bg-success');
                            enrollmentModal.hide();

                            // Reload page after a short delay
                            setTimeout(function() {
                                location.reload();
                            }, 1500);
                        } else {
                            var errorMsg = res.message || 'Operation failed';
                            if (res.errors && res.errors.length > 0) {
                                errorMsg += '<br><small>' + res.errors.join('<br>') + '</small>';
                            }
                            showToast(errorMsg, 'bg-danger');
                        }
                    },
                    error: function (xhr) {
                        loadingOverlay.hide();
                        $('#saveEnrollmentBtn').prop('disabled', false);

                        var errorMsg = 'Failed to save enrollment';
                        if (xhr.responseJSON) {
                            errorMsg = xhr.responseJSON.message || errorMsg;
                            if (xhr.responseJSON.errors && xhr.responseJSON.errors.length > 0) {
                                errorMsg += '<br><small>' + xhr.responseJSON.errors.join('<br>') + '</small>';
                            }
                        }
                        showToast(errorMsg, 'bg-danger');
                    }
                });
            });

            // Delete Enrollment
            $(document).on('click', '.btn-delete', function () {
                if (!confirm('Are you sure you want to delete this enrollment? This action cannot be undone.')) {
                    return;
                }

                var id = $(this).data('id');

                $.ajax({
                    url: `/api/EnrollmentsApi/${id}`,
                    method: 'DELETE',
                    beforeSend: function() {
                        loadingOverlay.show();
                    },
                    success: function (res) {
                        loadingOverlay.hide();
                        if (res.success) {
                            showToast(res.message || 'Enrollment deleted successfully', 'bg-success');
                            setTimeout(function() {
                                location.reload();
                            }, 1500);
                        } else {
                            showToast(res.message || 'Failed to delete enrollment', 'bg-danger');
                        }
                    },
                    error: function (xhr) {
                        loadingOverlay.hide();
                        var errorMsg = xhr.responseJSON?.message || 'Failed to delete enrollment';
                        showToast(errorMsg, 'bg-danger');
                    }
                });
            });

            // Clean up modal on hide
            $('#enrollmentModal').on('hidden.bs.modal', function () {
                resetForm();
            });
        });
    </script>
}